!function(){"use strict";const e=/^5\d{8}$/,t="+966";function r(e=""){const t={"٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9"};return String(e).split("").map(e=>t[e]??e).join("").replace(/[^0-9+]/g,"")}function s(e=""){let t=r(e).replace(/^\+/,"");return t.startsWith("966")&&(t=t.substring(3)),t.startsWith("00966")&&(t=t.replace(/^00/,"")),t.startsWith("0")&&(t=t.substring(1)),t}const o={init(){const e=document.getElementById("driver-registration-form");if(!e)return;this.setupPhoneHelpers(e),e.addEventListener("submit",t=>{t.preventDefault();const r=document.getElementById("submitted_at_field");r&&(r.value=(new Date).toISOString()),this.validateForm(e)&&this.submitForm(e)});e.querySelectorAll("input[required], textarea[required], select[required]").forEach(e=>{e.addEventListener("blur",()=>this.validateField(e)),e.addEventListener("input",()=>this.clearFieldError(e))})},setupPhoneHelpers(o){const i=o.querySelector("#phone_local")||o.querySelector('input[name="phone_local"]'),n=o.querySelector("#phone_e164"),l=o.querySelector("#phone_error");if(i){const r=()=>{const r=s(i.value);e.test(r)?(n&&(n.value=t+r),l&&(l.textContent=""),i.classList.remove("is-invalid")):n&&(n.value="")};i.addEventListener("input",()=>{r(),this.clearFieldError(i)}),i.addEventListener("blur",()=>{const t=s(i.value);e.test(t)?l&&(l.textContent=""):(this.showFieldError(i,"الرقم غير صالح. مثال صحيح: 5xxxxxxxx"),l&&(l.textContent="الرقم غير صالح. مثال صحيح: 5xxxxxxxx"))})}const a=o.querySelector("#sponsor_phone")||o.querySelector('input[name="sponsor_phone"]');a&&a.addEventListener("input",()=>{a.value=r(a.value).replace(/[^0-9+]/g,"")})},validateForm(r){let o=!0;const i=r.querySelector('input[name="full_name"]'),n=r.querySelector('input[name="email"]'),l=r.querySelector("#phone_local")||r.querySelector('input[name="phone_local"]'),a=r.querySelector('input[name="city"]'),c=r.querySelector('select[name="vehicle_type"]'),d=r.querySelector('input[name="agree_terms"]');if(i&&!i.value.trim()&&(this.showFieldError(i,"هذا الحقل مطلوب"),o=!1),n&&!n.value.trim()&&(this.showFieldError(n,"هذا الحقل مطلوب"),o=!1),a&&!a.value.trim()&&(this.showFieldError(a,"هذا الحقل مطلوب"),o=!1),c&&!c.value&&(this.showFieldError(c,"الرجاء اختيار نوع وسيلة التوصيل"),o=!1),d&&!d.checked&&(this.showFieldError(d,"يجب الموافقة على الشروط والأحكام"),o=!1),l){const i=s(l.value);if(e.test(i)){const e=r.querySelector("#phone_e164");e&&(e.value=t+i)}else this.showFieldError(l,"الرقم غير صالح. مثال صحيح: 5xxxxxxxx"),o=!1}return o},validateField(t){this.clearFieldError(t);const r=t.tagName.toLowerCase(),o=t.type,i=(t.value||"").trim();if(t.hasAttribute("required"))if("checkbox"===o){if(!t.checked)return this.showFieldError(t,"هذا الحقل مطلوب"),!1}else if(!i)return this.showFieldError(t,"هذا الحقل مطلوب"),!1;if("email"===o&&i){if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i))return this.showFieldError(t,"يرجى إدخال بريد إلكتروني صحيح"),!1}if("tel"===o&&i){const r=s(i);if(!e.test(r))return this.showFieldError(t,"الرقم غير صالح. مثال صحيح: 5xxxxxxxx"),!1}return!("textarea"===r&&i.length&&i.length<10)||(this.showFieldError(t,"الرجاء إدخال 10 أحرف على الأقل"),!1)},showFieldError(e,t){this.clearFieldError(e);const r=e.parentNode||e.closest(".form-group")||document.createElement("div"),s=document.createElement("div");s.className="field-error",s.textContent=t,s.style.cssText="color:#dc3545;font-size:13px;margin-top:6px;direction:rtl;text-align:right;",r.appendChild(s);try{e.classList.add("is-invalid"),e.style.borderColor="#dc3545"}catch(e){}},clearFieldError(e){const t=e.parentNode;if(!t)return;const r=t.querySelector(".field-error");r&&r.remove(),e.classList.remove("is-invalid"),e.style.borderColor=""},async submitForm(e){const t=e.querySelector('button[type="submit"]');t&&(t.disabled=!0,t.dataset.orig=t.innerHTML,t.innerHTML='<i class="ph ph-circle-notch" style="animation:spin 1s linear infinite;margin-inline-start:8px"></i> جاري الإرسال...');const r=new FormData(e);try{try{let e=0,t=0;for(const s of r.entries()){e++;try{s[1]instanceof File&&t++}catch(e){}}}catch(e){}const t=await fetch("/.netlify/functions/register-driver",{method:"POST",body:r});let s=null;try{s=await t.json()}catch(e){}t.ok&&s&&s.success?(this.showSuccessMessage(e,s.message||"تم إرسال الطلب بنجاح."),e.reset()):t.ok&&!s?(this.showSuccessMessage(e,"تم إرسال الطلب."),e.reset()):this.showErrorMessage(e,s&&s.error||"حدث خطأ أثناء الإرسال. يرجى المحاولة لاحقًا.")}catch(t){this.showErrorMessage(e,"خطأ في الشبكة. تحقق من اتصالك وحاول مرة أخرى.")}finally{t&&(t.disabled=!1,t.innerHTML=t.dataset.orig||t.innerHTML)}},showSuccessMessage(e,t){this.removeAlerts(e);const r=document.createElement("div");r.className="alert alert-success driver-form-alert",r.textContent=t,r.style.cssText="margin-top:16px;padding:12px;border-radius:8px;",e.appendChild(r),setTimeout(()=>r.remove(),6e3)},showErrorMessage(e,t){this.removeAlerts(e);const r=document.createElement("div");r.className="alert alert-danger driver-form-alert",r.textContent=t,r.style.cssText="margin-top:16px;padding:12px;border-radius:8px;",e.appendChild(r),setTimeout(()=>r.remove(),8e3)},removeAlerts(e){e.querySelectorAll(".driver-form-alert").forEach(e=>e.remove())}},i=document.createElement("style");i.textContent="\n        @keyframes spin { from{transform:rotate(0)} to{transform:rotate(360deg)} }\n        .is-invalid { border-color: #dc3545 !important; }\n        .field-error { color:#dc3545; font-size:13px; margin-top:6px; }\n    ",document.head.appendChild(i),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>o.init()):o.init(),window.DriverFormHandler=o}();